<!DOCTYPE html>
<html>
<head>
    <title>{{ t.todos }}</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 1rem; background-color: #fafafa; color: #333; }
        h1 { text-align: center; color: #333; }
        .todo-list { list-style: none; padding: 0; }
        .todo-item { background: white; padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; align-items: flex-start; border: 1px solid #eee; }
        .todo-item.done .title { text-decoration: line-through; color: #999; }
        .checkbox { margin-right: 1rem; cursor: pointer; text-decoration: none; font-size: 1.4rem; line-height: 1; color: #3584e4; }
        .checkbox.unchecked { color: #ccc; }
        .content { flex-grow: 1; }
        .title { font-size: 1rem; line-height: 1.4; }
        .meta { font-size: 0.85rem; color: #666; margin-top: 0.3rem; display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .tag { background: #f0f0f0; padding: 2px 8px; border-radius: 12px; color: #555; }
        .tag.project { color: #e66100; background: #fff1e5; }
        .tag.context { color: #1a5fb4; background: #eef5ff; }
        .tag.recurrence { color: #0b6c6a; background: #e5f4f2; display: inline-flex; align-items: center; gap: 4px; }
        .due { color: #c01c28; font-weight: 500; }
        .add-form { display: flex; margin-bottom: 2rem; box-shadow: 0 2px 6px rgba(0,0,0,0.1); border-radius: 8px; }
        .add-form input { flex-grow: 1; padding: 0.8rem; border: 1px solid #ddd; border-right: none; border-radius: 8px 0 0 8px; font-size: 1rem; outline: none; }
        .add-form input:focus { border-color: #3584e4; }
        .add-form button { padding: 0.8rem 1.5rem; background: #3584e4; color: white; border: none; border-radius: 0 8px 8px 0; cursor: pointer; font-size: 1rem; font-weight: bold; }
        .add-form button:hover { background: #1c71d8; }
        .section-header { margin-top: 2rem; margin-bottom: 1rem; font-size: 1.2rem; font-weight: 600; color: #333; padding-bottom: 0.5rem; border-bottom: 2px solid #eee; }
        
        .filter-link { text-decoration: none; color: #999; font-weight: normal; }
        .filter-link.active { color: #3584e4; font-weight: bold; }
        .refresh-button { background: #e0e0e0; border: 1px solid #ccc; border-radius: 6px; padding: 0.4rem 0.8rem; cursor: pointer; font-weight: 500; font-size: 0.9rem; color: #333; }
        .refresh-button:hover { background: #d8d8d8; }
        
        .lang-link { text-decoration: none; font-size: 1.5rem; padding-bottom: 2px; border-bottom: 2px solid transparent; }
        .lang-link.active { border-bottom-color: #3584e4; }

        .header-container { display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 1rem; position: relative; }
        .header-container h1 { margin: 0; }
        .header-icons { display: flex; gap: 0.5rem; }
        .icon-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background 0.2s; color: #666; }
        .icon-btn:hover { background: #eee; }
        .icon-btn.active { color: #3584e4; background: #eef5ff; }

        .voice-btn { background: none; border: none; cursor: pointer; padding: 0.5rem; display: flex; align-items: center; justify-content: center; color: #666; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; }
        .voice-btn:hover { background: #eee; }
        .voice-btn.recording { color: #c01c28; animation: pulse 1.5s infinite; background: #fdeef0; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .collapsible-form { display: none; margin-bottom: 1rem; }
        .collapsible-form.visible { display: flex; }
        
        /* Mobile improvements */
        input { font-size: 16px; }
        button, .checkbox, .filter-link { touch-action: manipulation; }

        @media (prefers-color-scheme: dark) {
            body { background-color: #1e1e1e; color: #e0e0e0; }
            h1 { color: #e0e0e0; }
            .todo-item { background: #2d2d2d; border-color: #444; }
            .todo-item.done .title { color: #666; }
            .checkbox.unchecked { color: #555; }
            .meta { color: #aaa; }
            .tag { background: #3d3d3d; color: #ccc; }
            .tag.project { background: #4a2c1a; color: #ffb380; }
            .tag.context { background: #1a3b5c; color: #8cb4ff; }
            .tag.recurrence { background: #1f3b3a; color: #7ad1c4; }
            .due { color: #ff7b72; }
            .add-form input { background: #2d2d2d; border-color: #444; color: #e0e0e0; }
            .add-form button { background: #3584e4; }
            .section-header { color: #e0e0e0; border-bottom-color: #444; }
            .filter-link { color: #888; }
            .filter-link.active { color: #78aeed; }
            .icon-btn { color: #aaa; }
            .icon-btn:hover { background: #3d3d3d; }
            .icon-btn.active { color: #78aeed; background: #1a3b5c; }
            .voice-btn { color: #aaa; border-color: #444; }
            .voice-btn:hover { background: #3d3d3d; }
            .voice-btn.recording { background: #4a1a1a; color: #ff7b72; }
        }

        /* Modal Styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgb(0,0,0); 
            background-color: rgba(0,0,0,0.4); 
            padding-top: 60px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; 
            padding: 20px;
            padding-bottom: 40px;
            border: 1px solid #888;
            width: 90%; 
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        
        @media screen and (max-width: 600px) {
            .modal { padding-top: 10px; }
            .modal-content { margin: 2% auto; width: 95%; padding: 15px; padding-bottom: 8rem; }
        }
        
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .modal input[type="text"], .modal input[type="date"] { width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; box-sizing: border-box; }
        .modal input[type="checkbox"] { transform: scale(1.5); margin-right: 0.5rem; }
        .buttons { display: flex; gap: 0.5rem; margin-top: 1.5rem; flex-wrap: wrap; }
        .btn-primary { background: #3584e4; color: white; padding: 0.8rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; font-weight: bold; }
        .btn-secondary { background: #e0e0e0; color: #333; padding: 0.8rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; font-weight: bold; text-decoration: none; text-align: center; }
        .btn-action { background: #f6f5f4; border: 1px solid #ddd; color: #333; padding: 0.5rem; border-radius: 4px; cursor: pointer; text-decoration: none; display: inline-block; line-height: 1; }
        .btn-action:hover { background: #e0e0e0; }

        @media (prefers-color-scheme: dark) {
            .modal-content { background-color: #2d2d2d; color: #e0e0e0; border-color: #555; }
            .modal { background-color: rgba(0,0,0,0.8); }
            .close { color: #ccc; }
            .close:hover, .close:focus { color: #fff; }
            .modal input[type="text"], .modal input[type="date"] { background: #3d3d3d; border-color: #555; color: #e0e0e0; }
            .btn-secondary { background: #3d3d3d; color: #e0e0e0; }
            .btn-primary { background: #4a90e2; }
            .btn-action { background: #3d3d3d; border-color: #555; color: #e0e0e0; }
            .refresh-button { background: #333; border-color: #555; color: #e0e0e0; }
            .refresh-button:hover { background: #3d3d3d; }
            #comment-section { background: #3d3d3d !important; border-color: #555 !important; }
        }
    </style>
</head>
<body>
    <!-- Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>{{ t.edit_todo }}</h2>
            <form id="editForm" method="post">
                <div class="form-group">
                    <label for="edit-title">{{ t.title }}</label>
                    <input type="text" id="edit-title" name="title" required>
                </div>
                <div class="form-group">
                    <label for="edit-project">{{ t.project }}</label>
                    <input type="text" id="edit-project" name="project">
                </div>
                <div class="form-group">
                    <label for="edit-context">{{ t.context }}</label>
                    <input type="text" id="edit-context" name="context">
                </div>
                <div class="form-group">
                    <label for="edit-due">{{ t.due_date }}</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="date" id="edit-due" name="due">
                        <button type="button" class="btn-action" onclick="setModalDate(0)" title="{{ t.today }}">üìÖ</button>
                        <button type="button" class="btn-action" onclick="setModalDate(1)" title="{{ t.tomorrow }}">‚û°Ô∏è</button>
                        <button type="button" class="btn-action" onclick="setModalSometimes()" title="{{ t.sometimes }}">üïí</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="edit-recurrence">{{ t.recurrence }}</label>
                    <select id="edit-recurrence" name="recurrence" style="width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">{{ t.recurrence_none }}</option>
                        <option value="daily">{{ t.recurrence_daily }}</option>
                        <option value="weekly">{{ t.recurrence_weekly }}</option>
                        <option value="monthly">{{ t.recurrence_monthly }}</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-reference">{{ t.reference }}</label>
                    <input type="text" id="edit-reference" name="reference">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="edit-done" name="done">
                        {{ t.done }}
                    </label>
                </div>

                <div id="comment-section" style="display: none; margin-top: 1rem; padding: 1rem; background: #f6f5f4; border-radius: 8px; border: 1px solid #ddd;">
                    <div class="form-group">
                        <label for="edit-comment">{{ t.comment }}</label>
                        <input type="text" id="edit-comment" name="comment" placeholder="...">
                    </div>
                    <button type="button" class="btn-primary" style="width: 100%;" onclick="submitWithComment()">{{ t.save }}</button>
                </div>
                
                <div class="buttons">
                    <button type="submit" id="btn-save-main" class="btn-primary">{{ t.save }}</button>
                    <button type="button" id="btn-close-comment" class="btn-secondary" onclick="showCommentField()">{{ t.close_with_comment }}</button>
                    <button type="button" id="btn-delete" class="btn-secondary" style="color: #e01b24;" onclick="deleteTodoFromModal()" title="{{ t.delete }}">üóëÔ∏è</button>
                    <button type="button" class="btn-secondary" onclick="closeModal()">{{ t.cancel }}</button>
                </div>
            </form>
        </div>
    </div>

    <div class="header-container">
        <h1>{{ t.todos }}</h1>
        <div class="header-icons">
            <button type="button" id="toggle-search" class="icon-btn {% if q %}active{% endif %}" onclick="toggleSearch()" title="{{ t.search_placeholder }}">üîç</button>
            <button type="button" id="toggle-add" class="icon-btn" onclick="toggleAdd()" title="{{ t.add }}">‚ûï</button>
        </div>
    </div>
    
    <div class="filters" style="margin-bottom: 1rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; align-items: center;">
        <a href="{{ url_for('index', show_done=0 if show_done else 1, show_due_only=1 if show_due_only else 0, sort_mode=sort_mode) }}" 
           class="filter-link {% if show_done %}active{% endif %}" onclick="applyFilter(event, this.href)">
           {% if show_done %}‚òë {{ t.show_done }}{% else %}‚òê {{ t.show_done }}{% endif %}
        </a>
        
        <a href="{{ url_for('index', show_done=1 if show_done else 0, show_due_only=0 if show_due_only else 1, sort_mode=sort_mode) }}"
           class="filter-link {% if show_due_only %}active{% endif %}" onclick="applyFilter(event, this.href)">
           {% if show_due_only %}‚òë {{ t.hide_future }}{% else %}‚òê {{ t.hide_future }}{% endif %}
        </a>

        <span style="color: #ccc;">|</span>

        <a href="{{ url_for('index', show_done=1 if show_done else 0, show_due_only=1 if show_due_only else 0, sort_mode='topic') }}"
           class="filter-link {% if sort_mode == 'topic' %}active{% endif %}" onclick="applyFilter(event, this.href)">
           {{ t.topic }}
        </a>
        <a href="{{ url_for('index', show_done=1 if show_done else 0, show_due_only=1 if show_due_only else 0, sort_mode='location') }}"
           class="filter-link {% if sort_mode == 'location' %}active{% endif %}" onclick="applyFilter(event, this.href)">
           {{ t.location }}
        </a>
        <a href="{{ url_for('index', show_done=1 if show_done else 0, show_due_only=1 if show_due_only else 0, sort_mode='date') }}"
           class="filter-link {% if sort_mode == 'date' %}active{% endif %}" onclick="applyFilter(event, this.href)">
           {{ t.date }}
        </a>

          <button type="button" class="refresh-button" onclick="manualReload()">‚Üª {{ t.reload }}</button>
    </div>
    
    <form id="search-form" action="{{ url_for('index') }}" method="get" class="collapsible-form {% if q %}visible{% endif %}" style="gap: 0.5rem;">
        <input type="text" id="search-input" name="q" value="{{ q or '' }}" placeholder="{{ t.search_placeholder }}" style="flex-grow: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 6px; outline: none;">
        <input type="hidden" name="show_done" value="{{ '1' if show_done else '0' }}">
        <input type="hidden" name="show_due_only" value="{{ '1' if show_due_only else '0' }}">
        <input type="hidden" name="sort_mode" value="{{ sort_mode }}">
        <button type="submit" style="padding: 0.5rem 1rem; background: #3584e4; color: white; border: none; border-radius: 6px; cursor: pointer;">{{ t.search_placeholder.strip('‚Ä¶') }}</button>
        {% if q %}
            <a href="{{ url_for('index', show_done='1' if show_done else '0', show_due_only='1' if show_due_only else '0', sort_mode=sort_mode) }}" 
               style="padding: 0.5rem 1rem; background: #e0e0e0; color: #333; border: none; border-radius: 6px; cursor: pointer; text-decoration: none; display: flex; align-items: center;">‚úï</a>
        {% endif %}
    </form>

    <form id="addForm" class="add-form collapsible-form" action="{{ url_for('add', show_done=1 if show_done else 0, show_due_only=1 if show_due_only else 0, sort_mode=sort_mode) }}" method="post" style="gap: 0;">
        <input type="text" id="add-input" name="title" placeholder="{{ t.new_task }}" required>
        <button type="button" id="voice-btn" class="voice-btn" title="{{ t.voice_input }}" style="display: none;">üé§</button>
        <button type="submit">{{ t.add }}</button>
    </form>

    <div class="todo-list">
        {% if q %}
            {% include '_search_results.html' %}
        {% else %}
            {% include '_todo_list.html' %}
        {% endif %}
    </div>

    <div style="text-align: center; margin-top: 2rem; margin-bottom: 2rem;">
        <div style="margin-bottom: 1rem; display: flex; justify-content: center; gap: 1rem;">
            <a href="{{ url_for('set_language', lang='de') }}" title="Deutsch" class="lang-link {% if current_lang == 'de' %}active{% endif %}">üá©üá™</a>
            <a href="{{ url_for('set_language', lang='en') }}" title="English" class="lang-link {% if current_lang == 'en' %}active{% endif %}">üá∫üá∏</a>
            <a href="{{ url_for('set_language', lang='es') }}" title="Espa√±ol" class="lang-link {% if current_lang == 'es' %}active{% endif %}">üá™üá∏</a>
            <a href="{{ url_for('set_language', lang='fr') }}" title="Fran√ßais" class="lang-link {% if current_lang == 'fr' %}active{% endif %}">üá´üá∑</a>
            <a href="{{ url_for('set_language', lang='sv') }}" title="Svenska" class="lang-link {% if current_lang == 'sv' %}active{% endif %}">üá∏üá™</a>
            <a href="{{ url_for('set_language', lang='ja') }}" title="Êó•Êú¨Ë™û" class="lang-link {% if current_lang == 'ja' %}active{% endif %}">üáØüáµ</a>
        </div>
        <a href="{{ url_for('logout') }}" style="color: #999; text-decoration: none; padding: 1rem; display: inline-block;">{{ t.logout }}</a>
        
        <div style="margin-top: 2rem; color: #999; font-size: 0.85rem; border-top: 1px solid #eee; padding-top: 1rem;">
            <p><strong>Reinschrift</strong> v0.9.31</p>
            <p>{{ t.developer }}: Dr. Daniel Dumke</p>
            <p><a href="https://github.com/danst0/ReinschriftTodo" target="_blank" style="color: #999;">{{ t.website }}</a> | CC-BY-SA-4.0</p>
        </div>
    </div>

    <!-- Cheatsheet Modal -->
    <div id="cheatsheetModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCheatsheet()">&times;</span>
            <h2>{{ t.cheatsheet }}</h2>
            <table style="width: 100%; border-collapse: collapse;">
                <tr><td style="padding: 4px 8px; text-align: right; color: #999; width: 40%;"><strong>?</strong></td><td style="padding: 4px 8px;">{{ t.key_help }}</td></tr>
                <tr><td style="padding: 4px 8px; text-align: right; color: #999;"><strong>n</strong></td><td style="padding: 4px 8px;">{{ t.key_new }}</td></tr>
                <tr><td style="padding: 4px 8px; text-align: right; color: #999;"><strong>f / /</strong></td><td style="padding: 4px 8px;">{{ t.key_search }}</td></tr>
                <tr><td style="padding: 4px 8px; text-align: right; color: #999;"><strong>j / k / ‚Üì / ‚Üë</strong></td><td style="padding: 4px 8px;">{{ t.key_nav }}</td></tr>
                <tr><td style="padding: 4px 8px; text-align: right; color: #999;"><strong>Space</strong></td><td style="padding: 4px 8px;">{{ t.key_toggle }}</td></tr>
                <tr><td style="padding: 4px 8px; text-align: right; color: #999;"><strong>Enter</strong></td><td style="padding: 4px 8px;">{{ t.key_edit }}</td></tr>
                <tr><td style="padding: 4px 8px; text-align: right; color: #999;"><strong>t</strong></td><td style="padding: 4px 8px;">{{ t.key_today }}</td></tr>
                <tr><td style="padding: 4px 8px; text-align: right; color: #999;"><strong>+</strong></td><td style="padding: 4px 8px;">{{ t.key_tomorrow }}</td></tr>
                <tr><td style="padding: 4px 8px; text-align: right; color: #999;"><strong>s</strong></td><td style="padding: 4px 8px;">{{ t.key_sometimes }}</td></tr>
            </table>
        </div>
    </div>

    <script>
        var modal = document.getElementById("editModal");

        function toggleTodo(event, lineIndex) {
            event.stopPropagation();
            fetch('/toggle/' + lineIndex)
                .then(() => autoReload());
        }

        function postponeTodo(event, lineIndex, target) {
            event.stopPropagation();
            fetch('/postpone/' + lineIndex + '/' + target)
                .then(() => autoReload());
        }

        document.getElementById('editForm').onsubmit = function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch(this.action, {
                method: 'POST',
                body: formData
            }).then(() => {
                closeModal();
                autoReload();
            });
        };

        // Clear search on Esc
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const searchInput = document.getElementById('search-input');
                const searchForm = document.getElementById('search-form');
                const addForm = document.getElementById('addForm');
                
                if (searchInput && searchInput.value) {
                    window.location.href = "{{ url_for('index', show_done='1' if show_done else '0', show_due_only='1' if show_due_only else '0', sort_mode=sort_mode) }}";
                } else {
                    if (searchForm.classList.contains('visible')) toggleSearch();
                    if (addForm.classList.contains('visible')) toggleAdd();
                }
            }
        });

        function toggleSearch() {
            const form = document.getElementById('search-form');
            const btn = document.getElementById('toggle-search');
            const input = document.getElementById('search-input');
            const isVisible = form.classList.toggle('visible');
            btn.classList.toggle('active', isVisible || "{{ q }}" !== "");
            if (isVisible) {
                input.focus();
                document.getElementById('addForm').classList.remove('visible');
                document.getElementById('toggle-add').classList.remove('active');
            }
        }

        function toggleAdd() {
            const form = document.getElementById('addForm');
            const btn = document.getElementById('toggle-add');
            const input = document.getElementById('add-input');
            const isVisible = form.classList.toggle('visible');
            btn.classList.toggle('active', isVisible);
            if (isVisible) {
                input.focus();
                document.getElementById('search-form').classList.remove('visible');
                if ("{{ q }}" === "") {
                    document.getElementById('toggle-search').classList.remove('active');
                }
            }
        }

        document.getElementById('addForm').onsubmit = function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch(this.action, {
                method: 'POST',
                body: formData
            }).then(() => {
                this.reset();
                autoReload();
            });
        };

        function applyFilter(event, url) {
            event.preventDefault();
            // Update URL without reload
            window.history.pushState({}, '', url);
            
            // Fetch partial content
            const fetchUrl = new URL(url);
            fetchUrl.searchParams.set('partial', '1');
            
            fetch(fetchUrl)
                .then(response => response.text())
                .then(html => {
                    document.querySelector('.todo-list').innerHTML = html;
                    // Update active classes in filters
                    updateFilterUI(url);
                });
        }

        function updateFilterUI(currentUrl) {
            const url = new URL(currentUrl);
            const showDone = url.searchParams.get('show_done') === '1';
            const showDueOnly = url.searchParams.get('show_due_only') === '1';
            const sortMode = url.searchParams.get('sort_mode') || 'topic';

            document.querySelectorAll('.filter-link').forEach(link => {
                const linkUrl = new URL(link.href);
                const linkSort = linkUrl.searchParams.get('sort_mode');
                const linkShowDone = linkUrl.searchParams.get('show_done');
                const linkShowDueOnly = linkUrl.searchParams.get('show_due_only');

                link.classList.remove('active');

                // Check if it's a sort link
                if (linkSort && linkSort === sortMode) {
                    link.classList.add('active');
                }
                // Check if it's a toggle link
                if (linkShowDone !== null && linkShowDone !== (showDone ? '1' : '0')) {
                     // This is the toggle link for show_done
                     if (showDone) link.classList.add('active');
                     link.innerHTML = showDone ? '‚òë {{ t.show_done }}' : '‚òê {{ t.show_done }}';
                }
                if (linkShowDueOnly !== null && linkShowDueOnly !== (showDueOnly ? '1' : '0')) {
                     // This is the toggle link for show_due_only
                     if (showDueOnly) link.classList.add('active');
                     link.innerHTML = showDueOnly ? '‚òë {{ t.hide_future }}' : '‚òê {{ t.hide_future }}';
                }
                
                // Update href to reflect new state
                const newHref = new URL(link.href);
                if (linkSort) {
                    newHref.searchParams.set('show_done', showDone ? '1' : '0');
                    newHref.searchParams.set('show_due_only', showDueOnly ? '1' : '0');
                } else if (linkShowDone !== null) {
                    newHref.searchParams.set('show_done', showDone ? '0' : '1');
                    newHref.searchParams.set('show_due_only', showDueOnly ? '1' : '0');
                    newHref.searchParams.set('sort_mode', sortMode);
                } else if (linkShowDueOnly !== null) {
                    newHref.searchParams.set('show_done', showDone ? '1' : '0');
                    newHref.searchParams.set('show_due_only', showDueOnly ? '0' : '1');
                    newHref.searchParams.set('sort_mode', sortMode);
                }
                link.href = newHref.toString();
            });
            
            // Update the Add form action to preserve filters
            const addForm = document.getElementById('addForm');
            const addUrl = new URL(addForm.action);
            addUrl.searchParams.set('show_done', showDone ? '1' : '0');
            addUrl.searchParams.set('show_due_only', showDueOnly ? '1' : '0');
            addUrl.searchParams.set('sort_mode', sortMode);
            addForm.action = addUrl.toString();
        }

        function openEditModal(lineIndex) {
            fetch('/api/todo/' + lineIndex)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('{{ t.error_loading }} ' + data.error);
                        return;
                    }
                    
                    document.getElementById('edit-title').value = data.title;
                    document.getElementById('edit-project').value = data.project || '';
                    document.getElementById('edit-context').value = data.context || '';
                    document.getElementById('edit-due').value = data.due || '';
                    document.getElementById('edit-recurrence').value = data.recurrence || '';
                    document.getElementById('edit-reference').value = data.reference || '';
                    document.getElementById('edit-done').checked = data.done;
                    document.getElementById('btn-close-comment').style.display = data.done ? 'none' : 'inline-block';
                    document.getElementById('btn-save-main').style.display = 'inline-block';
                    document.getElementById('comment-section').style.display = 'none';
                    
                    document.getElementById('editForm').action = '/edit/' + lineIndex;
                    
                    modal.style.display = "block";
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('{{ t.failed_details }}');
                });
        }

        function closeModal() {
            modal.style.display = "none";
            document.getElementById('comment-section').style.display = 'none';
            document.getElementById('btn-close-comment').style.display = 'inline-block';
            document.getElementById('btn-save-main').style.display = 'inline-block';
            document.getElementById('edit-comment').value = '';
        }

        function deleteTodoFromModal() {
            const action = document.getElementById('editForm').action;
            const lineIndex = action.split('/').pop();
            if (confirm('{{ t.delete }}?')) {
                fetch('/delete/' + lineIndex, { method: 'POST' })
                    .then(() => {
                        closeModal();
                        autoReload();
                    });
            }
        }

        function showCommentField() {
            document.getElementById('comment-section').style.display = 'block';
            document.getElementById('edit-done').checked = true;
            document.getElementById('btn-close-comment').style.display = 'none';
            document.getElementById('btn-save-main').style.display = 'none';
            const commentInput = document.getElementById('edit-comment');
            commentInput.focus();
            setTimeout(() => {
                commentInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        }

        function submitWithComment() {
            const form = document.getElementById('editForm');
            form.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
        }

        function setModalDate(offset) {
            const dateInput = document.getElementById('edit-due');
            const today = new Date();
            today.setDate(today.getDate() + offset);
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            dateInput.value = `${yyyy}-${mm}-${dd}`;
        }

        function setModalSometimes() {
            const dateInput = document.getElementById('edit-due');
            dateInput.value = '9999-12-31';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
        }

        function manualReload() {
            window.location.reload();
        }

        function autoReload() {
            // Construct URL with current params + partial=1
            const url = new URL(window.location.href);
            url.searchParams.set('partial', '1');
            
            fetch(url)
                .then(response => response.text())
                .then(html => {
                    document.querySelector('.todo-list').innerHTML = html;
                })
                .catch(err => console.error('Auto-reload failed', err));
        }
        
        // Reload every 10 seconds
        setInterval(autoReload, 10000);

        // Scroll position persistence
        window.addEventListener('beforeunload', () => {
            sessionStorage.setItem('scrollPos', window.scrollY);
        });

        window.addEventListener('load', () => {
            const scrollPos = sessionStorage.getItem('scrollPos');
            if (scrollPos) {
                window.scrollTo(0, parseInt(scrollPos));
                sessionStorage.removeItem('scrollPos');
            }
        });

        // Keyboard Navigation
        let selectedIndex = -1;

        function updateSelection() {
            const items = document.querySelectorAll('.todo-item');
            items.forEach((item, index) => {
                if (index === selectedIndex) {
                    item.style.border = '2px solid #3584e4';
                    item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    item.style.border = '1px solid #eee';
                }
            });
        }

        function closeCheatsheet() {
            document.getElementById('cheatsheetModal').style.display = "none";
        }

        document.addEventListener('keydown', function(e) {
            // Ignore if inside input or textarea
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                if (e.key === 'Escape') {
                    e.target.blur();
                }
                return;
            }

            if (e.key === '?') {
                document.getElementById('cheatsheetModal').style.display = "block";
            } else if (e.key === 'Escape') {
                closeModal();
                closeCheatsheet();
            } else if (!e.ctrlKey && !e.metaKey && e.key === 'n') {
                e.preventDefault();
                toggleAdd();
            } else if (!e.ctrlKey && !e.metaKey && (e.key === 'f' || e.key === '/')) {
                e.preventDefault();
                toggleSearch();
            } else if (e.key === 'j' || e.key === 'ArrowDown') {
                const items = document.querySelectorAll('.todo-item');
                if (selectedIndex < items.length - 1) {
                    selectedIndex++;
                    updateSelection();
                }
            } else if (e.key === 'k' || e.key === 'ArrowUp') {
                if (selectedIndex > 0) {
                    selectedIndex--;
                    updateSelection();
                } else if (selectedIndex === -1) {
                    selectedIndex = 0;
                    updateSelection();
                }
            } else if (e.key === ' ' && selectedIndex !== -1) {
                e.preventDefault();
                const items = document.querySelectorAll('.todo-item');
                const link = items[selectedIndex].querySelector('.checkbox');
                if (link) link.click();
            } else if (e.key === 'Enter' && selectedIndex !== -1) {
                const items = document.querySelectorAll('.todo-item');
                items[selectedIndex].click();
            } else if (e.key === 't' && selectedIndex !== -1) {
                 const items = document.querySelectorAll('.todo-item');
                 const onclick = items[selectedIndex].getAttribute('onclick');
                 const match = onclick.match(/openEditModal\((\d+)\)/);
                 if (match) {
                     const idx = match[1];
                     window.location.href = '/postpone/' + idx + '/today';
                 }
            } else if (e.key === '+' && selectedIndex !== -1) {
                 const items = document.querySelectorAll('.todo-item');
                 const onclick = items[selectedIndex].getAttribute('onclick');
                 const match = onclick.match(/openEditModal\((\d+)\)/);
                 if (match) {
                     const idx = match[1];
                     window.location.href = '/postpone/' + idx + '/tomorrow';
                 }
            } else if (e.key === 's' && selectedIndex !== -1) {
                 const items = document.querySelectorAll('.todo-item');
                 const onclick = items[selectedIndex].getAttribute('onclick');
                 const match = onclick.match(/openEditModal\((\d+)\)/);
                 if (match) {
                     const idx = match[1];
                     window.location.href = '/postpone/' + idx + '/sometimes';
                 }
            }
        });

        // Web Speech API Integration
        const voiceBtn = document.getElementById('voice-btn');
        const addInput = document.getElementById('add-input');
        const addForm = document.getElementById('addForm');

        // Only use voice input on mobile devices
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        if (isMobile && ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();

            recognition.lang = "{{ current_lang }}";
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            voiceBtn.style.display = 'flex';

            voiceBtn.onclick = () => {
                if (voiceBtn.classList.contains('recording')) {
                    recognition.stop();
                } else {
                    recognition.start();
                }
            };

            recognition.onstart = () => {
                voiceBtn.classList.add('recording');
            };

            recognition.onend = () => {
                voiceBtn.classList.remove('recording');
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                addInput.value = transcript;
                // Auto-submit form
                addForm.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                voiceBtn.classList.remove('recording');
            };
        }
    </script>
</body>
</html>
