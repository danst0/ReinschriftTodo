use std::sync::{Mutex, OnceLock};
use glib::language_names;

static OVERRIDE_LANG: OnceLock<Mutex<Option<String>>> = OnceLock::new();

pub fn set_language(lang: String) {
    let m = OVERRIDE_LANG.get_or_init(|| Mutex::new(None));
    if let Ok(mut guard) = m.lock() {
        *guard = Some(lang);
    }
}

pub fn t(key: &str) -> String {
    static TRANSLATIONS: OnceLock<std::collections::HashMap<&'static str, std::collections::HashMap<&'static str, &'static str>>> = OnceLock::new();
    
    let translations = TRANSLATIONS.get_or_init(|| {
        let mut m = std::collections::HashMap::new();
        
        let mut de = std::collections::HashMap::new();
        de.insert("app_title", "Reinschrift");
        de.insert("settings", "Einstellungen");
        de.insert("general", "Allgemein");
        de.insert("storage", "Speicher");
        de.insert("local_file", "Lokale Datei");
        de.insert("webdav", "WebDAV");
        de.insert("reload", "Neu laden (Ctrl+R)");
        de.insert("sort_by", "Sortieren nach:");
        de.insert("topics", "+ Themen");
        de.insert("locations", "@ Orte");
        de.insert("date", "Datum");
        de.insert("show_due_only", "Nur fällige anzeigen");
        de.insert("new_todo_placeholder", "Neues To-do…");
        de.insert("add", "Hinzufügen");
        de.insert("title_empty_error", "Titel darf nicht leer sein");
        de.insert("reload_error", "Konnte To-dos nicht neu laden: {}");
        de.insert("task_added", "Aufgabe hinzugefügt");
        de.insert("create_error", "Konnte To-do nicht anlegen: {}");
        de.insert("load_error", "Konnte To-dos nicht laden: {}");
        de.insert("select_valid_file", "Bitte wählen Sie eine gültige Datei in den Einstellungen.");
        de.insert("monitor_error", "Dateiüberwachung nicht verfügbar: {}");
        de.insert("set_due_today", "Fälligkeit auf heute setzen");
        de.insert("postpone_tomorrow", "Auf morgen verschieben");
        de.insert("postpone_sometimes", "Auf 'Irgendwann' verschieben");
        de.insert("sometimes", "Irgendwann");
        de.insert("update_error", "Konnte Eintrag nicht aktualisieren: {}");
        de.insert("set_due_error", "Konnte Fälligkeit setzen: {}");
        de.insert("no_window", "Kein Fenster verfügbar");
        de.insert("show_completed", "Erledigte Aufgaben anzeigen");
        de.insert("show_due_only_settings", "Nur fällige (<= heute) anzeigen");
        de.insert("use_webdav", "WebDAV verwenden");
        de.insert("use_this_method", "Diese Methode verwenden");
        de.insert("database_file", "Datenbankdatei");
        de.insert("select_file", "Datei auswählen…");
        de.insert("webdav_url", "WebDAV URL");
        de.insert("path_relative", "Pfad (relativ)");
        de.insert("username", "Benutzername");
        de.insert("password", "Passwort");
        de.insert("check_connection", "Verbindung prüfen");
        de.insert("no_url_error", "Keine URL angegeben.");
        de.insert("connection_success", "Verbindung erfolgreich!");
        de.insert("connection_failed", "Verbindung fehlgeschlagen: {}");
        de.insert("close", "Schließen");
        de.insert("file_not_exists", "Datei existiert nicht");
        de.insert("open_path_error", "Konnte Pfad nicht öffnen: {}");
        de.insert("file_already_active", "Diese Datei ist bereits aktiv");
        de.insert("using_file", "Nutze {}");
        de.insert("load_data_error", "Konnte Daten nicht laden: {}");
        de.insert("save_settings_error", "Konnte Einstellungen nicht speichern: {}");
        de.insert("updated_task", "Aktualisiert: {}");
        de.insert("edit_task", "Aufgabe bearbeiten");
        de.insert("section", "Bereich");
        de.insert("title", "Titel");
        de.insert("project_plus", "Projekt (+)");
        de.insert("location_at", "Ort (@)");
        de.insert("due_date", "Fälligkeitsdatum");
        de.insert("today", "Heute");
        de.insert("done", "Erledigt");
        de.insert("cancel", "Abbrechen");
        de.insert("save", "Speichern");
        de.insert("invalid_date_error", "Ungültiges Datum. Erwartet YYYY-MM-DD");
        de.insert("save_task_error", "Konnte Aufgabe nicht speichern: {}");
        de.insert("topic_group", "Thema: {}");
        de.insert("location_group", "Ort: {}");
        de.insert("no_project", "Ohne Projekt");
        de.insert("no_location", "Ohne Ort");
        de.insert("changes_applied", "Änderungen aus Datei übernommen");
        de.insert("update_failed", "Aktualisierung fehlgeschlagen: {}");
        de.insert("due_label", "Fällig: {}");
        de.insert("init_adw_error", "Konnte libadwaita nicht initialisieren");
        de.insert("build_ui_error", "Fehler beim Aufbau der Oberfläche: {:?}");
        de.insert("app_exit_status", "Anwendung wurde mit Status {:?} beendet");
        de.insert("read_error", "Konnte {} nicht lesen");
        de.insert("write_error", "Konnte {} nicht schreiben");
        de.insert("connection_error", "Verbindung zu '{}' fehlgeschlagen: {}");
        de.insert("no_section", "Ohne Abschnitt");
        de.insert("todo_not_found", "Konnte To-do in der Datei nicht finden");
        de.insert("line_update_error", "Konnte Zeile {} nicht aktualisieren");
        de.insert("no_checkbox_error", "Zeile enthält keine Checkbox");
        de.insert("auto_reload_error", "Automatisches Neuladen fehlgeschlagen: {}");
        de.insert("webdav_conn_error", "WebDAV-Verbindungsfehler: {}");
        de.insert("rollback_failed", "Rollback fehlgeschlagen: {}");
        de.insert("close_with_comment", "Mit Kommentar abschließen");
        de.insert("comment", "Kommentar");
        m.insert("de", de);

        let mut en = std::collections::HashMap::new();
        en.insert("app_title", "Reinschrift");
        en.insert("settings", "Settings");
        en.insert("general", "General");
        en.insert("storage", "Storage");
        en.insert("local_file", "Local File");
        en.insert("webdav", "WebDAV");
        en.insert("reload", "Reload (Ctrl+R)");
        en.insert("sort_by", "Sort by:");
        en.insert("topics", "+ Topics");
        en.insert("locations", "@ Locations");
        en.insert("date", "Date");
        en.insert("show_due_only", "Show only due");
        en.insert("new_todo_placeholder", "New To-do…");
        en.insert("add", "Add");
        en.insert("title_empty_error", "Title must not be empty");
        en.insert("reload_error", "Could not reload To-dos: {}");
        en.insert("task_added", "Task added");
        en.insert("create_error", "Could not create To-do: {}");
        en.insert("load_error", "Could not load To-dos: {}");
        en.insert("select_valid_file", "Please select a valid file in settings.");
        en.insert("monitor_error", "File monitoring not available: {}");
        en.insert("set_due_today", "Set due date to today");
        en.insert("postpone_tomorrow", "Postpone to tomorrow");
        en.insert("postpone_sometimes", "Postpone to 'sometimes'");
        en.insert("sometimes", "Sometimes");
        en.insert("update_error", "Could not update entry: {}");
        en.insert("set_due_error", "Could not set due date: {}");
        en.insert("no_window", "No window available");
        en.insert("show_completed", "Show completed tasks");
        en.insert("show_due_only_settings", "Show only due (<= today)");
        en.insert("use_webdav", "Use WebDAV");
        en.insert("use_this_method", "Use this method");
        en.insert("database_file", "Database file");
        en.insert("select_file", "Select file…");
        en.insert("webdav_url", "WebDAV URL");
        en.insert("path_relative", "Path (relative)");
        en.insert("username", "Username");
        en.insert("password", "Password");
        en.insert("check_connection", "Check connection");
        en.insert("no_url_error", "No URL specified.");
        en.insert("connection_success", "Connection successful!");
        en.insert("connection_failed", "Connection failed: {}");
        en.insert("close", "Close");
        en.insert("file_not_exists", "File does not exist");
        en.insert("open_path_error", "Could not open path: {}");
        en.insert("file_already_active", "This file is already active");
        en.insert("using_file", "Using {}");
        en.insert("load_data_error", "Could not load data: {}");
        en.insert("save_settings_error", "Could not save settings: {}");
        en.insert("updated_task", "Updated: {}");
        en.insert("edit_task", "Edit task");
        en.insert("section", "Section");
        en.insert("title", "Title");
        en.insert("project_plus", "Project (+)");
        en.insert("location_at", "Location (@)");
        en.insert("due_date", "Due date");
        en.insert("today", "Today");
        en.insert("done", "Done");
        en.insert("cancel", "Cancel");
        en.insert("save", "Save");
        en.insert("invalid_date_error", "Invalid date. Expected YYYY-MM-DD");
        en.insert("save_task_error", "Could not save task: {}");
        en.insert("topic_group", "Topic: {}");
        en.insert("location_group", "Location: {}");
        en.insert("no_project", "No project");
        en.insert("no_location", "No location");
        en.insert("changes_applied", "Changes from file applied");
        en.insert("update_failed", "Update failed: {}");
        en.insert("due_label", "Due: {}");
        en.insert("init_adw_error", "Could not initialize libadwaita");
        en.insert("build_ui_error", "Error building UI: {:?}");
        en.insert("app_exit_status", "Application exited with status {:?}");
        en.insert("read_error", "Could not read {}");
        en.insert("write_error", "Could not write {}");
        en.insert("connection_error", "Connection to '{}' failed: {}");
        en.insert("no_section", "No section");
        en.insert("todo_not_found", "Could not find To-do in file");
        en.insert("line_update_error", "Could not update line {}");
        en.insert("no_checkbox_error", "Line contains no checkbox");
        en.insert("auto_reload_error", "Auto-reload failed: {}");
        en.insert("webdav_conn_error", "WebDAV Connection Error: {}");
        en.insert("rollback_failed", "Rollback failed: {}");        en.insert("close_with_comment", "Close with comment");
        en.insert("comment", "Comment");        m.insert("en", en);

        let mut es = std::collections::HashMap::new();
        es.insert("app_title", "Base de datos de tareas");
        es.insert("settings", "Ajustes");
        es.insert("reload", "Recargar (Ctrl+R)");
        es.insert("sort_by", "Ordenar por:");
        es.insert("topics", "+ Temas");
        es.insert("locations", "@ Lugares");
        es.insert("date", "Fecha");
        es.insert("show_due_only", "Mostrar solo pendientes");
        es.insert("new_todo_placeholder", "Nueva tarea…");
        es.insert("add", "Añadir");
        es.insert("title_empty_error", "El título no puede estar vacío");
        es.insert("reload_error", "No se pudieron recargar las tareas: {}");
        es.insert("task_added", "Tarea añadida");
        es.insert("create_error", "No se pudo crear la tarea: {}");
        es.insert("load_error", "No se pudieron cargar las tareas: {}");
        es.insert("select_valid_file", "Por favor, seleccione un archivo válido en los ajustes.");
        es.insert("monitor_error", "Monitorización de archivos no disponible: {}");
        es.insert("set_due_today", "Establecer vencimiento para hoy");
        es.insert("postpone_tomorrow", "Posponer para mañana");
        es.insert("postpone_sometimes", "Posponer para 'algún momento'");
        es.insert("sometimes", "Algún momento");
        es.insert("update_error", "No se pudo actualizar la entrada: {}");
        es.insert("set_due_error", "No se pudo establecer el vencimiento: {}");
        es.insert("no_window", "No hay ventana disponible");
        es.insert("show_completed", "Mostrar tareas completadas");
        es.insert("show_due_only_settings", "Mostrar solo pendientes (<= hoy)");
        es.insert("use_webdav", "Usar WebDAV");
        es.insert("database_file", "Archivo de base de datos");
        es.insert("select_file", "Seleccionar archivo…");
        es.insert("webdav_url", "URL de WebDAV");
        es.insert("path_relative", "Ruta (relativa)");
        es.insert("username", "Nombre de usuario");
        es.insert("password", "Contraseña");
        es.insert("check_connection", "Comprobar conexión");
        es.insert("no_url_error", "No se ha especificado ninguna URL.");
        es.insert("connection_success", "¡Conexión exitosa!");
        es.insert("connection_failed", "Conexión fallida: {}");
        es.insert("close", "Cerrar");
        es.insert("file_not_exists", "El archivo no existe");
        es.insert("open_path_error", "No se pudo abrir la ruta: {}");
        es.insert("file_already_active", "Este archivo ya está activo");
        es.insert("using_file", "Usando {}");
        es.insert("load_data_error", "No se pudieron cargar los datos: {}");
        es.insert("save_settings_error", "No se pudieron guardar los ajustes: {}");
        es.insert("updated_task", "Actualizado: {}");
        es.insert("edit_task", "Editar tarea");
        es.insert("section", "Sección");
        es.insert("title", "Título");
        es.insert("project_plus", "Proyecto (+)");
        es.insert("location_at", "Lugar (@)");
        es.insert("due_date", "Fecha de vencimiento");
        es.insert("today", "Hoy");
        es.insert("done", "Hecho");
        es.insert("cancel", "Cancelar");
        es.insert("save", "Guardar");
        es.insert("invalid_date_error", "Fecha no válida. Se espera AAAA-MM-DD");
        es.insert("save_task_error", "No se pudo guardar la tarea: {}");
        es.insert("topic_group", "Tema: {}");
        es.insert("location_group", "Lugar: {}");
        es.insert("no_project", "Sin proyecto");
        es.insert("no_location", "Sin lugar");
        es.insert("changes_applied", "Cambios del archivo aplicados");
        es.insert("update_failed", "Fallo al actualizar: {}");
        es.insert("due_label", "Vence: {}");
        es.insert("init_adw_error", "No se pudo inicializar libadwaita");
        es.insert("build_ui_error", "Error al construir la interfaz: {:?}");
        es.insert("app_exit_status", "La aplicación finalizó con el estado {:?}");
        es.insert("read_error", "No se pudo leer {}");
        es.insert("write_error", "No se pudo escribir {}");
        es.insert("connection_error", "Conexión a '{}' fallida: {}");
        es.insert("no_section", "Sin sección");
        es.insert("todo_not_found", "No se pudo encontrar la tarea en el archivo");
        es.insert("line_update_error", "No se pudo actualizar la línea {}");
        es.insert("no_checkbox_error", "La línea no contiene ninguna casilla");
        es.insert("auto_reload_error", "Fallo en la recarga automática: {}");
        es.insert("webdav_conn_error", "Error de conexión WebDAV: {}");
        es.insert("rollback_failed", "Fallo en la reversión: {}");
        es.insert("close_with_comment", "Cerrar con comentario");
        es.insert("comment", "Comentario");
        m.insert("es", es);

        let mut sv = std::collections::HashMap::new();
        sv.insert("app_title", "Att göra-databas");
        sv.insert("settings", "Inställningar");
        sv.insert("reload", "Uppdatera (Ctrl+R)");
        sv.insert("sort_by", "Sortera efter:");
        sv.insert("topics", "+ Ämnen");
        sv.insert("locations", "@ Platser");
        sv.insert("date", "Datum");
        sv.insert("show_due_only", "Visa endast förfallna");
        sv.insert("new_todo_placeholder", "Ny uppgift…");
        sv.insert("add", "Lägg till");
        sv.insert("title_empty_error", "Titeln får inte vara tom");
        sv.insert("reload_error", "Kunde inte uppdatera uppgifter: {}");
        sv.insert("task_added", "Uppgift tillagd");
        sv.insert("create_error", "Kunde inte skapa uppgift: {}");
        sv.insert("load_error", "Kunde inte ladda uppgifter: {}");
        sv.insert("select_valid_file", "Välj en giltig fil i inställningarna.");
        sv.insert("monitor_error", "Filövervakning inte tillgänglig: {}");
        sv.insert("set_due_today", "Sätt förfallodatum till idag");
        sv.insert("postpone_tomorrow", "Skjut upp till imorgon");
        sv.insert("postpone_sometimes", "Skjut upp till 'när som helst'");
        sv.insert("sometimes", "När som helst");
        sv.insert("update_error", "Kunde inte uppdatera posten: {}");
        sv.insert("set_due_error", "Kunde inte sätta förfallodatum: {}");
        sv.insert("no_window", "Inget fönster tillgängligt");
        sv.insert("show_completed", "Visa klara uppgifter");
        sv.insert("show_due_only_settings", "Visa endast förfallna (<= idag)");
        sv.insert("use_webdav", "Använd WebDAV");
        sv.insert("database_file", "Databasfil");
        sv.insert("select_file", "Välj fil…");
        sv.insert("webdav_url", "WebDAV URL");
        sv.insert("path_relative", "Sökväg (relativ)");
        sv.insert("username", "Användarnamn");
        sv.insert("password", "Lösenord");
        sv.insert("check_connection", "Kontrollera anslutning");
        sv.insert("no_url_error", "Ingen URL angiven.");
        sv.insert("connection_success", "Anslutning lyckades!");
        sv.insert("connection_failed", "Anslutning misslyckades: {}");
        sv.insert("close", "Stäng");
        sv.insert("file_not_exists", "Filen finns inte");
        sv.insert("open_path_error", "Kunde inte öppna sökvägen: {}");
        sv.insert("file_already_active", "Denna fil är redan aktiv");
        sv.insert("using_file", "Använder {}");
        sv.insert("load_data_error", "Kunde inte ladda data: {}");
        sv.insert("save_settings_error", "Kunde inte spara inställningar: {}");
        sv.insert("updated_task", "Uppdaterad: {}");
        sv.insert("edit_task", "Redigera uppgift");
        sv.insert("section", "Sektion");
        sv.insert("title", "Titel");
        sv.insert("project_plus", "Projekt (+)");
        sv.insert("location_at", "Plats (@)");
        sv.insert("due_date", "Förfallodatum");
        sv.insert("today", "Idag");
        sv.insert("done", "Klar");
        sv.insert("cancel", "Avbryt");
        sv.insert("save", "Spara");
        sv.insert("invalid_date_error", "Ogiltigt datum. Förväntat ÅÅÅÅ-MM-DD");
        sv.insert("save_task_error", "Kunde inte spara uppgift: {}");
        sv.insert("topic_group", "Ämne: {}");
        sv.insert("location_group", "Plats: {}");
        sv.insert("no_project", "Utan projekt");
        sv.insert("no_location", "Utan plats");
        sv.insert("changes_applied", "Ändringar från filen har tillämpats");
        sv.insert("update_failed", "Uppdatering misslyckades: {}");
        sv.insert("due_label", "Förfaller: {}");
        sv.insert("init_adw_error", "Kunde inte initiera libadwaita");
        sv.insert("build_ui_error", "Fel vid uppbyggnad av gränssnitt: {:?}");
        sv.insert("app_exit_status", "Programmet avslutades med status {:?}");
        sv.insert("read_error", "Kunde inte läsa {}");
        sv.insert("write_error", "Kunde inte skriva {}");
        sv.insert("connection_error", "Anslutning till '{}' misslyckades: {}");
        sv.insert("no_section", "Ingen sektion");
        sv.insert("todo_not_found", "Kunde inte hitta uppgiften i filen");
        sv.insert("line_update_error", "Kunde inte uppdatera rad {}");
        sv.insert("no_checkbox_error", "Raden innehåller ingen kryssruta");
        sv.insert("auto_reload_error", "Automatisk omladdning misslyckades: {}");
        sv.insert("webdav_conn_error", "WebDAV-anslutningsfel: {}");
        sv.insert("rollback_failed", "Återställning misslyckades: {}");
        sv.insert("close_with_comment", "Stäng med kommentar");
        sv.insert("comment", "Kommentar");
        m.insert("sv", sv);

        let mut fr = std::collections::HashMap::new();
        fr.insert("app_title", "Base de données de tâches");
        fr.insert("settings", "Paramètres");
        fr.insert("reload", "Recharger (Ctrl+R)");
        fr.insert("sort_by", "Trier par :");
        fr.insert("topics", "+ Sujets");
        fr.insert("locations", "@ Lieux");
        fr.insert("date", "Date");
        fr.insert("show_due_only", "Afficher uniquement les échéances");
        fr.insert("new_todo_placeholder", "Nouvelle tâche…");
        fr.insert("add", "Ajouter");
        fr.insert("title_empty_error", "Le titre ne peut pas être vide");
        fr.insert("reload_error", "Impossible de recharger les tâches : {}");
        fr.insert("task_added", "Tâche ajoutée");
        fr.insert("create_error", "Impossible de créer la tâche : {}");
        fr.insert("load_error", "Impossible de charger les tâches : {}");
        fr.insert("select_valid_file", "Veuillez sélectionner un fichier valide dans les paramètres.");
        fr.insert("monitor_error", "Surveillance des fichiers non disponible : {}");
        fr.insert("set_due_today", "Régler l'échéance à aujourd'hui");
        fr.insert("postpone_tomorrow", "Reporter à demain");
        fr.insert("postpone_sometimes", "Reporter à 'un jour'");
        fr.insert("sometimes", "Un jour");
        fr.insert("update_error", "Impossible de mettre à jour l'entrée : {}");
        fr.insert("set_due_error", "Impossible de régler l'échéance : {}");
        fr.insert("no_window", "Aucune fenêtre disponible");
        fr.insert("show_completed", "Afficher les tâches terminées");
        fr.insert("show_due_only_settings", "Afficher uniquement les échéances (<= aujourd'hui)");
        fr.insert("use_webdav", "Utiliser WebDAV");
        fr.insert("database_file", "Fichier de base de données");
        fr.insert("select_file", "Sélectionner un fichier…");
        fr.insert("webdav_url", "URL WebDAV");
        fr.insert("path_relative", "Chemin (relatif)");
        fr.insert("username", "Nom d'utilisateur");
        fr.insert("password", "Mot de passe");
        fr.insert("check_connection", "Vérifier la connexion");
        fr.insert("no_url_error", "Aucune URL spécifiée.");
        fr.insert("connection_success", "Connexion réussie !");
        fr.insert("connection_failed", "Échec de la connexion : {}");
        fr.insert("close", "Fermer");
        fr.insert("file_not_exists", "Le fichier n'existe pas");
        fr.insert("open_path_error", "Impossible d'ouvrir le chemin : {}");
        fr.insert("file_already_active", "Ce fichier est déjà actif");
        fr.insert("using_file", "Utilisation de {}");
        fr.insert("load_data_error", "Impossible de charger les données : {}");
        fr.insert("save_settings_error", "Impossible d'enregistrer les paramètres : {}");
        fr.insert("updated_task", "Mis à jour : {}");
        fr.insert("edit_task", "Modifier la tâche");
        fr.insert("section", "Section");
        fr.insert("title", "Titre");
        fr.insert("project_plus", "Projet (+)");
        fr.insert("location_at", "Lieu (@)");
        fr.insert("due_date", "Date d'échéance");
        fr.insert("today", "Aujourd'hui");
        fr.insert("done", "Terminé");
        fr.insert("cancel", "Annuler");
        fr.insert("save", "Enregistrer");
        fr.insert("invalid_date_error", "Date invalide. Format attendu AAAA-MM-DD");
        fr.insert("save_task_error", "Impossible d'enregistrer la tâche : {}");
        fr.insert("topic_group", "Sujet : {}");
        fr.insert("location_group", "Lieu : {}");
        fr.insert("no_project", "Sans projet");
        fr.insert("no_location", "Sans lieu");
        fr.insert("changes_applied", "Modifications du fichier appliquées");
        fr.insert("update_failed", "Échec de la mise à jour : {}");
        fr.insert("due_label", "Échéance : {}");
        fr.insert("init_adw_error", "Impossible d'initialiser libadwaita");
        fr.insert("build_ui_error", "Erreur lors de la construction de l'interface : {:?}");
        fr.insert("app_exit_status", "L'application s'est terminée avec le statut {:?}");
        fr.insert("read_error", "Impossible de lire {}");
        fr.insert("write_error", "Impossible d'écrire {}");
        fr.insert("connection_error", "Connexion à '{}' échouée : {}");
        fr.insert("no_section", "Sans section");
        fr.insert("todo_not_found", "Impossible de trouver la tâche dans le fichier");
        fr.insert("line_update_error", "Impossible de mettre à jour la ligne {}");
        fr.insert("no_checkbox_error", "La ligne ne contient pas de case à cocher");
        fr.insert("auto_reload_error", "Échec du rechargement automatique : {}");
        fr.insert("webdav_conn_error", "Erreur de connexion WebDAV : {}");
        fr.insert("rollback_failed", "Échec de la restauration : {}");
        fr.insert("close_with_comment", "Fermer avec commentaire");
        fr.insert("comment", "Commentaire");
        m.insert("fr", fr);

        let mut ja = std::collections::HashMap::new();
        ja.insert("app_title", "ToDo データベース");
        ja.insert("settings", "設定");
        ja.insert("reload", "再読み込み (Ctrl+R)");
        ja.insert("sort_by", "並べ替え:");
        ja.insert("topics", "+ トピック");
        ja.insert("locations", "@ 場所");
        ja.insert("date", "日付");
        ja.insert("show_due_only", "期限内のみ表示");
        ja.insert("new_todo_placeholder", "新しいタスク…");
        ja.insert("add", "追加");
        ja.insert("title_empty_error", "タイトルを入力してください");
        ja.insert("reload_error", "タスクを再読み込みできませんでした: {}");
        ja.insert("task_added", "タスクを追加しました");
        ja.insert("create_error", "タスクを作成できませんでした: {}");
        ja.insert("load_error", "タスクを読み込めませんでした: {}");
        ja.insert("select_valid_file", "設定で有効なファイルを選択してください。");
        ja.insert("monitor_error", "ファイル監視を利用できません: {}");
        ja.insert("set_due_today", "期限を今日に設定");
        ja.insert("postpone_tomorrow", "明日に延期");
        ja.insert("postpone_sometimes", "「いつか」に延期");
        ja.insert("sometimes", "いつか");
        ja.insert("update_error", "項目を更新できませんでした: {}");
        ja.insert("set_due_error", "期限を設定できませんでした: {}");
        ja.insert("no_window", "ウィンドウがありません");
        ja.insert("show_completed", "完了したタスクを表示");
        ja.insert("show_due_only_settings", "期限内 (今日まで) のみ表示");
        ja.insert("use_webdav", "WebDAV を使用する");
        ja.insert("database_file", "データベースファイル");
        ja.insert("select_file", "ファイルを選択…");
        ja.insert("webdav_url", "WebDAV URL");
        ja.insert("path_relative", "パス (相対)");
        ja.insert("username", "ユーザー名");
        ja.insert("password", "パスワード");
        ja.insert("check_connection", "接続を確認");
        ja.insert("no_url_error", "URL が指定されていません。");
        ja.insert("connection_success", "接続に成功しました！");
        ja.insert("connection_failed", "接続に失敗しました: {}");
        ja.insert("close", "閉じる");
        ja.insert("file_not_exists", "ファイルが存在しません");
        ja.insert("open_path_error", "パスを開けませんでした: {}");
        ja.insert("file_already_active", "このファイルは既に使用されています");
        ja.insert("using_file", "{} を使用中");
        ja.insert("load_data_error", "データを読み込めませんでした: {}");
        ja.insert("save_settings_error", "設定を保存できませんでした: {}");
        ja.insert("updated_task", "更新済み: {}");
        ja.insert("edit_task", "タスクを編集");
        ja.insert("section", "セクション");
        ja.insert("title", "タイトル");
        ja.insert("project_plus", "プロジェクト (+)");
        ja.insert("location_at", "場所 (@)");
        ja.insert("due_date", "期限");
        ja.insert("today", "今日");
        ja.insert("done", "完了");
        ja.insert("cancel", "キャンセル");
        ja.insert("save", "保存");
        ja.insert("invalid_date_error", "日付が無効です。YYYY-MM-DD 形式で入力してください");
        ja.insert("save_task_error", "タスクを保存できませんでした: {}");
        ja.insert("topic_group", "トピック: {}");
        ja.insert("location_group", "場所: {}");
        ja.insert("no_project", "プロジェクトなし");
        ja.insert("no_location", "場所なし");
        ja.insert("changes_applied", "ファイルからの変更を適用しました");
        ja.insert("update_failed", "更新に失敗しました: {}");
        ja.insert("due_label", "期限: {}");
        ja.insert("init_adw_error", "libadwaita を初期化できませんでした");
        ja.insert("build_ui_error", "UI の構築中にエラーが発生しました: {:?}");
        ja.insert("app_exit_status", "アプリケーションがステータス {:?} で終了しました");
        ja.insert("read_error", "{} を読み込めませんでした");
        ja.insert("write_error", "{} を書き込めませんでした");
        ja.insert("connection_error", "'{}' への接続に失敗しました: {}");
        ja.insert("no_section", "セクションなし");
        ja.insert("todo_not_found", "ファイル内にタスクが見つかりませんでした");
        ja.insert("line_update_error", "行 {} を更新できませんでした");
        ja.insert("no_checkbox_error", "行にチェックボックスが含まれていません");
        ja.insert("auto_reload_error", "自動再読み込みに失敗しました: {}");
        ja.insert("webdav_conn_error", "WebDAV 接続エラー: {}");
        ja.insert("rollback_failed", "ロールバックに失敗しました: {}");
        ja.insert("close_with_comment", "コメント付きで終了");
        ja.insert("comment", "コメント");
        m.insert("ja", ja);

        m
    });

    let langs = if let Some(Some(override_lang)) = OVERRIDE_LANG.get().map(|m| m.lock().ok().and_then(|g| g.clone())) {
        vec![glib::GString::from(override_lang)]
    } else {
        language_names()
    };
    for lang in langs {
        let lang_str = lang.as_str();
        let lang_code = lang_str.split('_').next().unwrap_or(lang_str).split('.').next().unwrap_or(lang_str);
        if let Some(map) = translations.get(lang_code) {
            if let Some(val) = map.get(key) {
                return val.to_string();
            }
        }
    }
    
    // Fallback to German as requested
    translations.get("de").and_then(|m| m.get(key)).unwrap_or(&key).to_string()
}
